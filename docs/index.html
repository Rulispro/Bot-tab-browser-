<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Multi Akun Facebook - Simpan Cookies</title>
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6.2.0/dist/idb-keyval.iife.js"></script>
</head>
<body>
  <h2>Facebook Multi-Akun</h2>

  <label for="accountName">Nama Akun:</label><br>
  <input type="text" id="accountName" placeholder="Contoh: FB Utama"><br><br>

  <label for="cookieInput">Tempel Cookies (dari ekstensi):</label><br>
  <textarea id="cookieInput" rows="6" cols="50" placeholder="Paste cookies di sini..."></textarea><br><br>

  <button onclick="simpanCookies()">üíæ Simpan Cookies</button>
  <button onclick="pakaiCookies()">üç™ Pakai Cookies</button>
  <button onclick="hapusSemua()">üóë Hapus Semua Akun</button>

  <h3>Pilih Akun Tersimpan:</h3>
  <select id="akunDropdown"></select>

  <script>
    const { set, get, del, clear, keys } = idbKeyval;
    const PREFIX = "fb-akun-";

    function convertStringToCookies(cookieStr) {
      return cookieStr.split(";").map(pair => {
        const [name, ...rest] = pair.trim().split("=");
        return {
          name,
          value: rest.join("="),
          domain: ".facebook.com",
          path: "/"
        };
      });
    }

    async function simpanCookies() {
      const accountName = document.getElementById('accountName').value.trim();
      const raw = document.getElementById('cookieInput').value.trim();

      if (!accountName || !raw) {
        alert("Isi semua kolom terlebih dahulu.");
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        try {
          parsed = convertStringToCookies(raw);
        } catch (e2) {
          return alert("Format cookies tidak dikenali.");
        }
      }

      await set(PREFIX + accountName, JSON.stringify(parsed));
      alert("Cookies berhasil disimpan!");
      tampilkanDropdown();
    }

    async function tampilkanDropdown() {
      const dropdown = document.getElementById("akunDropdown");
      dropdown.innerHTML = "";
      const semuaKey = await keys();

      if (semuaKey.length === 0) {
        dropdown.innerHTML = `<option disabled selected>Tidak ada akun tersimpan</option>`;
        return;
      }

      semuaKey.forEach((key) => {
        const option = document.createElement("option");
        option.value = key;
        option.innerText = key.replace(PREFIX, "");
        dropdown.appendChild(option);
      });
    }

    async function pakaiCookies() {
      const key = document.getElementById("akunDropdown").value;
      const data = await get(key);
      if (!data) return alert("Cookies tidak ditemukan!");

      try {
        const cookies = JSON.parse(data);
        cookies.forEach(cookie => {
          document.cookie = `${cookie.name}=${cookie.value}; domain=${cookie.domain}; path=${cookie.path || "/"};`;
        });

        alert("Cookies berhasil di-inject!\nSilakan reload tab Facebook.");
      } catch (e) {
        alert("Format cookies tidak valid!");
      }
    }

    async function hapusSemua() {
      if (confirm("Yakin ingin menghapus semua akun?")) {
        await clear();
        tampilkanDropdown();
        alert("Semua akun berhasil dihapus.");
      }
    }

    // Tampilkan dropdown saat halaman dimuat
    tampilkanDropdown();
  </script>
</body>
</html>
